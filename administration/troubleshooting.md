# Troubleshooting

* [Tap Functionality: generate events or records](troubleshooting.md#tap-functionality)
* [Dump Internals Signal](troubleshooting.md#dump-internals--signal)

## Tap Functionality

Tracing can be used to generate events or records detailing what messages
pass through fluent-bit, at what time and what filters affect them.

To test out tracing we will be using a publicly accessible docker container: 'fluent/fluent-bit:latest
'.

### Simple example

First we will make sure that the container we are going to use actually supports tracing:

```shell
$ docker run --rm -ti ghcr.io/calyptia/core/calyptia-fluent-bit:main --help | grep -Z
  -Z, --enable-chunk-trace     enable chunk tracing. activating it requires using the HTTP Server API.
```

If the `--enable-chunk-trace` option is present it means fluent-bit has tracing disabled by default, so has to be enabled when writing command.

Tracing support is enabled and disabled via the embedded API server, so to enable it while fluent-bit is running it must be turned on:

```shell
$ docker run --rm -ti -p 2020:2020 ghcr.io/calyptia/core/calyptia-fluent-bit:main -Z -H -i dummy -p alias=input_dummy -o stdout -f 1
Calyptia Fluent Bit v22.8, patch_level=1
* Enterprise Fluent Bit by Calyptia
* https://calyptia.com
* https://fluentbit.io

[2022/07/27 20:02:04] [ info] [calyptia fluent bit] version=22.8 patch=1 pid=1
[2022/07/27 20:02:04] [ info] [storage] version=1.2.0, type=memory-only, sync=normal, checksum=disabled, max_chunks_up=128
[2022/07/27 20:02:04] [ info] [cmetrics] version=0.3.5
[2022/07/27 20:02:04] [ info] [output:stdout:stdout.0] worker #0 started
[2022/07/27 20:02:04] [ info] [http_server] listen iface=0.0.0.0 tcp_port=2020
[2022/07/27 20:02:04] [ info] [sp] stream processor started
[0] dummy.0: [1658952125.096215620, {"message"=>"dummy"}]
[0] dummy.0: [1658952126.096222898, {"message"=>"dummy"}]
[0] dummy.0: [1658952127.096220305, {"message"=>"dummy"}]
...
```

In another window we can activate tracing by either using the instance id of the input; `dummy.0` or its alias. Since the alias is more predictable that is what we will use:


```shell
$ curl 127.0.0.1:2020/api/v1/trace/input_dummy
{"status":"ok"}
```

This response means we have activated tracing, the window with fluent-bit running should now look like this:

```shell
[0] dummy.0: [1658952148.096212481, {"message"=>"dummy"}]
[2022/07/27 20:02:29] [ info] [calyptia fluent bit] version=22.8 patch=1 pid=1
[2022/07/27 20:02:29] [ info] [storage] version=1.2.0, type=memory-only, sync=normal, checksum=disabled, max_chunks_up=128
[2022/07/27 20:02:29] [ info] [cmetrics] version=0.3.5
[2022/07/27 20:02:29] [ info] [sp] stream processor started
[2022/07/27 20:02:29] [ info] [output:stdout:stdout.0] worker #0 started
[0] dummy.0: [1658952149.096214459, {"message"=>"dummy"}]
[0] dummy.0: [1658952150.096211929, {"message"=>"dummy"}]
[0] trace: [1658952150.096228881, {"type"=>1, "trace_id"=>"trace.0", "plugin_instance"=>"dummy.0", "plugin_alias"=>"input_dummy", "records"=>[{"timestamp"=>1658952150, "record"=>{"message"=>"dummy"}}], "start_time"=>1658952150, "end_time"=>1658952150}]
[0] trace: [1658952150.096242907, {"type"=>3, "trace_id"=>"trace.0", "plugin_instance"=>"dummy.0", "plugin_alias"=>"input_dummy", "records"=>[{"timestamp"=>1658952150, "record"=>{"message"=>"dummy"}}], "start_time"=>1658952150, "end_time"=>1658952150}]
[0] dummy.0: [1658952151.096210939, [0] trace: [1658952151.096230847, {"type"=>1, "trace_id"=>"trace.1", "plugin_instance"=>"dummy.0", "plugin_alias"=>"input_dummy", "records"=>[{"timestamp"=>{1658952151"message"=>, "dummy"}"record"=>]
{"message"=>"dummy"}}], "start_time"=>1658952151, "end_time"=>1658952151}]
[0] trace: [1658952151.096258529, {"type"=>3, "trace_id"=>"trace.1", "plugin_instance"=>"dummy.0", "plugin_alias"=>"input_dummy", "records"=>[{"timestamp"=>1658952151, "record"=>{"message"=>"dummy"}}], "start_time"=>1658952151, "end_time"=>1658952151}]
```

All the records that now appear under trace are trace records emitted by the activities of the dummy plugin.

### Complex example

This example takes the same steps but demonstrates the same mechanism works with more complicated configurations. In this example we will trace a single input of many which passes through several filters.

```
$ docker run --rm -ti -p 2020:2020 \
	ghcr.io/calyptia/core/calyptia-fluent-bit:main \
	-Z -H \
		-i dummy -p alias=dummy_0 -p \
			dummy='{"dummy": "dummy_0", "key_name": "foo", "key_cnt": "1"}' \
		-i dummy -p alias=dummy_1 -p dummy='{"dummy": "dummy_1"}' \
		-i dummy -p alias=dummy_2 -p dummy='{"dummy": "dummy_2"}' \
		-F record_modifier -m 'dummy.0' -p record="powered_by calyptia" \
		-F record_modifier -m 'dummy.1' -p record="powered_by fluent-bit" \
		-F nest -m 'dummy.0' \
			-p operation=nest -p wildcard='key_*' -p nest_under=data \
		-o null -m '*' -f 1
```

To make sure the window is not cluttered by the actual records generated by the input plugins we send all of it to `null`.

We activate tracing with the following curl command:

```shell
$ curl 127.0.0.1:2020/api/v1/trace/dummy_0
{"status":"ok"}
```

Once we activate tracing we should see the trace records:

```shell
[0] trace: [1658953434.096232706, {"type"=>1, "trace_id"=>"trace.0", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953434, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953434, "end_time"=>1658953434}]
[0] trace: [1658953434.096249838, {"type"=>2, "start_time"=>1658953434, "end_time"=>1658953434, "trace_id"=>"trace.0", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953434, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953434.096258635, {"type"=>2, "start_time"=>1658953434, "end_time"=>1658953434, "trace_id"=>"trace.0", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953434, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953434.096409933, {"type"=>3, "trace_id"=>"trace.0", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953434, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953434, "end_time"=>1658953434}]
[0] trace: [1658953435.096254716, {"type"=>1, "trace_id"=>"trace.1", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953435, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953435, "end_time"=>1658953435}]
[0] trace: [1658953435.096280876, {"type"=>2, "start_time"=>1658953435, "end_time"=>1658953435, "trace_id"=>"trace.1", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953435, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953435.096295504, {"type"=>2, "start_time"=>1658953435, "end_time"=>1658953435, "trace_id"=>"trace.1", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953435, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953435.096306885, {"type"=>3, "trace_id"=>"trace.1", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953435, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953435, "end_time"=>1658953435}]
[0] trace: [1658953436.096241854, {"type"=>1, "trace_id"=>"trace.2", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953436, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953436, "end_time"=>1658953436}]
[0] trace: [1658953436.096264848, {"type"=>2, "start_time"=>1658953436, "end_time"=>1658953436, "trace_id"=>"trace.2", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953436, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953436.096276891, {"type"=>2, "start_time"=>1658953436, "end_time"=>1658953436, "trace_id"=>"trace.2", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953436, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953436.096284025, {"type"=>3, "trace_id"=>"trace.2", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953436, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953436, "end_time"=>1658953436}]
[0] trace: [1658953437.096244654, {"type"=>1, "trace_id"=>"trace.3", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953437, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953437, "end_time"=>1658953437}]
[0] trace: [1658953437.096267448, {"type"=>2, "start_time"=>1658953437, "end_time"=>1658953437, "trace_id"=>"trace.3", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953437, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953437.096278499, {"type"=>2, "start_time"=>1658953437, "end_time"=>1658953437, "trace_id"=>"trace.3", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953437, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953437.096285833, {"type"=>3, "trace_id"=>"trace.3", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953437, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953437, "end_time"=>1658953437}]
[0] trace: [1658953438.096256516, {"type"=>1, "trace_id"=>"trace.4", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953438, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953438, "end_time"=>1658953438}]
[0] trace: [1658953438.096283607, {"type"=>2, "start_time"=>1658953438, "end_time"=>1658953438, "trace_id"=>"trace.4", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953438, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953438.096297874, {"type"=>2, "start_time"=>1658953438, "end_time"=>1658953438, "trace_id"=>"trace.4", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953438, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953438.096307082, {"type"=>3, "trace_id"=>"trace.4", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953438, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953438, "end_time"=>1658953438}]
[0] trace: [1658953439.096256447, {"type"=>1, "trace_id"=>"trace.5", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953439, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953439, "end_time"=>1658953439}]
[0] trace: [1658953439.096277177, {"type"=>2, "start_time"=>1658953439, "end_time"=>1658953439, "trace_id"=>"trace.5", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953439, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953439.096291774, {"type"=>2, "start_time"=>1658953439, "end_time"=>1658953439, "trace_id"=>"trace.5", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953439, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953439.096298678, {"type"=>3, "trace_id"=>"trace.5", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953439, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953439, "end_time"=>1658953439}]
^C[2022/07/27 20:24:00] [engine] caught signal (SIGINT)
[2022/07/27 20:24:00] [ warn] [engine] service will shutdown in max 5 seconds
[0] trace: [1658953440.096253908, {"type"=>1, "trace_id"=>"trace.6", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953440, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953440, "end_time"=>1658953440}]
[2022/07/27 20:24:01] [ info] [engine] service has stopped (0 pending tasks)
[0] trace: [1658953440.096277973, {"type"=>2, "start_time"=>1658953440, "end_time"=>1658953440, "trace_id"=>"trace.6", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953440, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953440.096291459, {"type"=>2, "start_time"=>1658953440, "end_time"=>1658953440, "trace_id"=>"trace.6", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953440, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953440.096298913, {"type"=>3, "trace_id"=>"trace.6", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953440, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953440, "end_time"=>1658953440}]
```
### Analysis of a single trace record

Here I analyze a single trace record from a filter event to explain the meaning of each field in detail. I chose a filter record since it includes the most details of all the record types.

```json
{
	"type": 2,
	"start_time": 1658953439,
	"end_time": 1658953439,
	"trace_id": "trace.5",
	"plugin_instance": "nest.2", 
	"records": [{
		"timestamp": 1658953439,
		"record": {
			"dummy": "dummy_0",
			"powered_by": "calyptia",
			"data": {
				"key_name": "foo", 
				"key_cnt": "1"
			}
		}
	}]
}
```

### type

The type defines at what stage the event is generated:

- type=1: input record
  - this is the unadulterated input record
- type=2: filtered record
  - this is a record once it has been filtered. One record is generated per filter.
- type=3: pre-output record
  - this is the record right before it is sent for output.

Since this is a record generated by the manipulation of a record by a filter is has the type `2`.

### start_time and end_time

This records the start and end of an event, it is a bit different for each event type:

- type 1: when the input is received, both the start and end time.
- type 2: the time when filtering is matched until it has finished processing.
- type 3: the time when the input is received and when it is finally slated for output.

### trace_id

This is a string composed of a prefix and a number which is incremented with each record received by the input during the trace session.

### plugin_instance

This is the plugin instance name as it is generated by fluent-bit at runtime.

### plugin_alias

If an alias is set this field will contain the alias set for a plugin.

### records

This is an array of all the records being sent. Since fluent-bit handles records in chunks of multiple records and chunks are indivisible the same is done in the traces. Each record consists of its timestamp followed by the actual data which is a composite type of keys and values.

## Dump Internals / Signal

When the service is running we can export [metrics](monitoring.md) to see the overall status of the data flow of the service. But there are other use cases where we would like to know the current status of the internals of the service, specifically to answer questions like _what's the current status of the internal buffers ?_ , the Dump Internals feature is the answer.

Fluent Bit v1.4 introduces the Dump Internals feature that can be triggered easily from the command line triggering the `CONT` Unix signal.

{% hint style="info" %}
note: this feature is only available on Linux and BSD family operating systems
{% endhint %}

### Usage

Run the following `kill` command to signal Fluent Bit:

```text
kill -CONT `pidof fluent-bit`
```

> The command `pidof` aims to lookup the Process ID of Fluent Bit. You can replace the

Fluent Bit will dump the following information to the standard output interface \(stdout\):

```text
[engine] caught signal (SIGCONT)
[2020/03/23 17:39:02] Fluent Bit Dump

===== Input =====
syslog_debug (syslog)
│
├─ status
│  └─ overlimit     : no
│     ├─ mem size   : 60.8M (63752145 bytes)
│     └─ mem limit  : 61.0M (64000000 bytes)
│
├─ tasks
│  ├─ total tasks   : 92
│  ├─ new           : 0
│  ├─ running       : 92
│  └─ size          : 171.1M (179391504 bytes)
│
└─ chunks
   └─ total chunks  : 92
      ├─ up chunks  : 35
      ├─ down chunks: 57
      └─ busy chunks: 92
         ├─ size    : 60.8M (63752145 bytes)
         └─ size err: 0

===== Storage Layer =====
total chunks     : 92
├─ mem chunks    : 0
└─ fs chunks     : 92
   ├─ up         : 35
   └─ down       : 57
```

### Input Plugins Dump

The dump provides insights for every input instance configured.

### Status

Overall ingestion status of the plugin.

| Entry | Sub-entry | Description |
| :--- | :--- | :--- |
| overlimit |  | If the plugin has been configured with [Mem\_Buf\_Limit](backpressure.md), this entry will report if the plugin is over the limit or not at the moment of the dump. If it is overlimit, it will print `yes`, otherwise `no`. |
|  | mem\_size | Current memory size in use by the input plugin in-memory. |
|  | mem\_limit | Limit set by Mem\_Buf\_Limit. |

### Tasks

When an input plugin ingest data into the engine, a Chunk is created. A Chunk can contains multiple records. Upon flush time, the engine creates a Task that contains the routes for the Chunk associated in question.

The Task dump describes the tasks associated to the input plugin:

| Entry | Description |
| :--- | :--- |
| total\_tasks | Total number of active tasks associated to data generated by the input plugin. |
| new | Number of tasks not assigned yet to an output plugin. Tasks are in `new` status for a very short period of time \(most of the time this value is very low or zero\). |
| running | Number of active tasks being processed by output plugins. |
| size | Amount of memory used by the Chunks being processed \(Total chunks size\). |

### Chunks

The Chunks dump tells more details about all the chunks that the input plugin has generated and are still being processed.

Depending of the buffering strategy and limits imposed by configuration, some Chunks might be `up` \(in memory\) or `down` \(filesystem\).

| Entry | Sub-entry | Description |
| :--- | :--- | :--- |
| total\_chunks |  | Total number of Chunks generated by the input plugin that are still being processed by the engine. |
| up\_chunks |  | Total number of Chunks that are loaded in memory. |
| down\_chunks |  | Total number of Chunks that are stored in the filesystem but not loaded in memory yet. |
| busy\_chunks |  | Chunks marked as busy \(being flushed\) or locked. Busy Chunks are immutable and likely are ready to \(or being\) processed. |
|  | size | Amount of bytes used by the Chunk. |
|  | size err | Number of Chunks in an error state where it size could not be retrieved. |

### Storage Layer Dump

Fluent Bit relies on a custom storage layer interface designed for hybrid buffering. The `Storage Layer` entry contains a total summary of Chunks registered by Fluent Bit:

| Entry | Sub-Entry | Description |
| :--- | :--- | :--- |
| total chunks |  | Total number of Chunks |
| mem chunks |  | Total number of Chunks memory-based |
| fs chunks |  | Total number of Chunks filesystem based |
|  | up | Total number of filesystem chunks up in memory |
|  | down | Total number of filesystem chunks down \(not loaded in memory\) |



[README.md](https://github.com/calyptia/core-images/files/9203490/README.md)
