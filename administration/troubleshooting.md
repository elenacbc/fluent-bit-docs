Here is a simple readme documenting how to use trace using the fluent-bit image generated by this repository. 

# Introduction

Tracing can be used to generate events or records detailing what messages
pass through fluent-bit, at what time and what filters affect them.

To test out tracing we will be using a publicly accessible docker container: `ghcr.io/calyptia/core/calyptia-fluent-bit:main`.

## Simple example

First we will make sure that the container we are going to use actually supports tracing:

```shell
$ docker run --rm -ti ghcr.io/calyptia/core/calyptia-fluent-bit:main --help | grep -Z
  -Z, --enable-chunk-trace     enable chunk tracing. activating it requires using the HTTP Server API.
```

If the `--enable-chunk-trace` option is present it means fluent-bit has tracing disabled by default, so has to be enabled when writing command.

Tracing support is enabled and disabled via the embedded API server, so to enable it while fluent-bit is running it must be turned on:

```shell
$ docker run --rm -ti -p 2020:2020 ghcr.io/calyptia/core/calyptia-fluent-bit:main -Z -H -i dummy -p alias=input_dummy -o stdout -f 1
Calyptia Fluent Bit v22.8, patch_level=1
* Enterprise Fluent Bit by Calyptia
* https://calyptia.com
* https://fluentbit.io

[2022/07/27 20:02:04] [ info] [calyptia fluent bit] version=22.8 patch=1 pid=1
[2022/07/27 20:02:04] [ info] [storage] version=1.2.0, type=memory-only, sync=normal, checksum=disabled, max_chunks_up=128
[2022/07/27 20:02:04] [ info] [cmetrics] version=0.3.5
[2022/07/27 20:02:04] [ info] [output:stdout:stdout.0] worker #0 started
[2022/07/27 20:02:04] [ info] [http_server] listen iface=0.0.0.0 tcp_port=2020
[2022/07/27 20:02:04] [ info] [sp] stream processor started
[0] dummy.0: [1658952125.096215620, {"message"=>"dummy"}]
[0] dummy.0: [1658952126.096222898, {"message"=>"dummy"}]
[0] dummy.0: [1658952127.096220305, {"message"=>"dummy"}]
...
```

In another window we can activate tracing by either using the instance id of the input; `dummy.0` or its alias. Since the alias is more predictable that is what we will use:


```shell
$ curl 127.0.0.1:2020/api/v1/trace/input_dummy
{"status":"ok"}
```

This response means we have activated tracing, the window with fluent-bit running should now look like this:

```shell
[0] dummy.0: [1658952148.096212481, {"message"=>"dummy"}]
[2022/07/27 20:02:29] [ info] [calyptia fluent bit] version=22.8 patch=1 pid=1
[2022/07/27 20:02:29] [ info] [storage] version=1.2.0, type=memory-only, sync=normal, checksum=disabled, max_chunks_up=128
[2022/07/27 20:02:29] [ info] [cmetrics] version=0.3.5
[2022/07/27 20:02:29] [ info] [sp] stream processor started
[2022/07/27 20:02:29] [ info] [output:stdout:stdout.0] worker #0 started
[0] dummy.0: [1658952149.096214459, {"message"=>"dummy"}]
[0] dummy.0: [1658952150.096211929, {"message"=>"dummy"}]
[0] trace: [1658952150.096228881, {"type"=>1, "trace_id"=>"trace.0", "plugin_instance"=>"dummy.0", "plugin_alias"=>"input_dummy", "records"=>[{"timestamp"=>1658952150, "record"=>{"message"=>"dummy"}}], "start_time"=>1658952150, "end_time"=>1658952150}]
[0] trace: [1658952150.096242907, {"type"=>3, "trace_id"=>"trace.0", "plugin_instance"=>"dummy.0", "plugin_alias"=>"input_dummy", "records"=>[{"timestamp"=>1658952150, "record"=>{"message"=>"dummy"}}], "start_time"=>1658952150, "end_time"=>1658952150}]
[0] dummy.0: [1658952151.096210939, [0] trace: [1658952151.096230847, {"type"=>1, "trace_id"=>"trace.1", "plugin_instance"=>"dummy.0", "plugin_alias"=>"input_dummy", "records"=>[{"timestamp"=>{1658952151"message"=>, "dummy"}"record"=>]
{"message"=>"dummy"}}], "start_time"=>1658952151, "end_time"=>1658952151}]
[0] trace: [1658952151.096258529, {"type"=>3, "trace_id"=>"trace.1", "plugin_instance"=>"dummy.0", "plugin_alias"=>"input_dummy", "records"=>[{"timestamp"=>1658952151, "record"=>{"message"=>"dummy"}}], "start_time"=>1658952151, "end_time"=>1658952151}]
```

All the records that now appear under trace are trace records emitted by the activities of the dummy plugin.

## Complex example

This example takes the same steps but demonstrates the same mechanism works with more complicated configurations. In this example we will trace a single input of many which passes through several filters.

```
$ docker run --rm -ti -p 2020:2020 \
	ghcr.io/calyptia/core/calyptia-fluent-bit:main \
	-Z -H \
		-i dummy -p alias=dummy_0 -p \
			dummy='{"dummy": "dummy_0", "key_name": "foo", "key_cnt": "1"}' \
		-i dummy -p alias=dummy_1 -p dummy='{"dummy": "dummy_1"}' \
		-i dummy -p alias=dummy_2 -p dummy='{"dummy": "dummy_2"}' \
		-F record_modifier -m 'dummy.0' -p record="powered_by calyptia" \
		-F record_modifier -m 'dummy.1' -p record="powered_by fluent-bit" \
		-F nest -m 'dummy.0' \
			-p operation=nest -p wildcard='key_*' -p nest_under=data \
		-o null -m '*' -f 1
```

To make sure the window is not cluttered by the actual records generated by the input plugins we send all of it to `null`.

We activate tracing with the following curl command:

```shell
$ curl 127.0.0.1:2020/api/v1/trace/dummy_0
{"status":"ok"}
```

Once we activate tracing we should see the trace records:

```shell
[0] trace: [1658953434.096232706, {"type"=>1, "trace_id"=>"trace.0", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953434, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953434, "end_time"=>1658953434}]
[0] trace: [1658953434.096249838, {"type"=>2, "start_time"=>1658953434, "end_time"=>1658953434, "trace_id"=>"trace.0", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953434, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953434.096258635, {"type"=>2, "start_time"=>1658953434, "end_time"=>1658953434, "trace_id"=>"trace.0", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953434, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953434.096409933, {"type"=>3, "trace_id"=>"trace.0", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953434, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953434, "end_time"=>1658953434}]
[0] trace: [1658953435.096254716, {"type"=>1, "trace_id"=>"trace.1", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953435, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953435, "end_time"=>1658953435}]
[0] trace: [1658953435.096280876, {"type"=>2, "start_time"=>1658953435, "end_time"=>1658953435, "trace_id"=>"trace.1", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953435, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953435.096295504, {"type"=>2, "start_time"=>1658953435, "end_time"=>1658953435, "trace_id"=>"trace.1", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953435, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953435.096306885, {"type"=>3, "trace_id"=>"trace.1", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953435, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953435, "end_time"=>1658953435}]
[0] trace: [1658953436.096241854, {"type"=>1, "trace_id"=>"trace.2", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953436, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953436, "end_time"=>1658953436}]
[0] trace: [1658953436.096264848, {"type"=>2, "start_time"=>1658953436, "end_time"=>1658953436, "trace_id"=>"trace.2", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953436, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953436.096276891, {"type"=>2, "start_time"=>1658953436, "end_time"=>1658953436, "trace_id"=>"trace.2", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953436, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953436.096284025, {"type"=>3, "trace_id"=>"trace.2", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953436, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953436, "end_time"=>1658953436}]
[0] trace: [1658953437.096244654, {"type"=>1, "trace_id"=>"trace.3", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953437, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953437, "end_time"=>1658953437}]
[0] trace: [1658953437.096267448, {"type"=>2, "start_time"=>1658953437, "end_time"=>1658953437, "trace_id"=>"trace.3", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953437, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953437.096278499, {"type"=>2, "start_time"=>1658953437, "end_time"=>1658953437, "trace_id"=>"trace.3", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953437, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953437.096285833, {"type"=>3, "trace_id"=>"trace.3", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953437, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953437, "end_time"=>1658953437}]
[0] trace: [1658953438.096256516, {"type"=>1, "trace_id"=>"trace.4", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953438, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953438, "end_time"=>1658953438}]
[0] trace: [1658953438.096283607, {"type"=>2, "start_time"=>1658953438, "end_time"=>1658953438, "trace_id"=>"trace.4", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953438, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953438.096297874, {"type"=>2, "start_time"=>1658953438, "end_time"=>1658953438, "trace_id"=>"trace.4", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953438, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953438.096307082, {"type"=>3, "trace_id"=>"trace.4", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953438, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953438, "end_time"=>1658953438}]
[0] trace: [1658953439.096256447, {"type"=>1, "trace_id"=>"trace.5", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953439, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953439, "end_time"=>1658953439}]
[0] trace: [1658953439.096277177, {"type"=>2, "start_time"=>1658953439, "end_time"=>1658953439, "trace_id"=>"trace.5", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953439, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953439.096291774, {"type"=>2, "start_time"=>1658953439, "end_time"=>1658953439, "trace_id"=>"trace.5", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953439, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953439.096298678, {"type"=>3, "trace_id"=>"trace.5", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953439, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953439, "end_time"=>1658953439}]
^C[2022/07/27 20:24:00] [engine] caught signal (SIGINT)
[2022/07/27 20:24:00] [ warn] [engine] service will shutdown in max 5 seconds
[0] trace: [1658953440.096253908, {"type"=>1, "trace_id"=>"trace.6", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953440, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1"}}], "start_time"=>1658953440, "end_time"=>1658953440}]
[2022/07/27 20:24:01] [ info] [engine] service has stopped (0 pending tasks)
[0] trace: [1658953440.096277973, {"type"=>2, "start_time"=>1658953440, "end_time"=>1658953440, "trace_id"=>"trace.6", "plugin_instance"=>"record_modifier.0", "records"=>[{"timestamp"=>1658953440, "record"=>{"dummy"=>"dummy_0", "key_name"=>"foo", "key_cnt"=>"1", "powered_by"=>"calyptia"}}]}]
[0] trace: [1658953440.096291459, {"type"=>2, "start_time"=>1658953440, "end_time"=>1658953440, "trace_id"=>"trace.6", "plugin_instance"=>"nest.2", "records"=>[{"timestamp"=>1658953440, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}]}]
[0] trace: [1658953440.096298913, {"type"=>3, "trace_id"=>"trace.6", "plugin_instance"=>"dummy.0", "plugin_alias"=>"dummy_0", "records"=>[{"timestamp"=>1658953440, "record"=>{"dummy"=>"dummy_0", "powered_by"=>"calyptia", "data"=>{"key_name"=>"foo", "key_cnt"=>"1"}}}], "start_time"=>1658953440, "end_time"=>1658953440}]
```
## Analysis of a single trace record

Here I analyze a single trace record from a filter event to explain the meaning of each field in detail. I chose a filter record since it includes the most details of all the record types.

```json
{
	"type": 2,
	"start_time": 1658953439,
	"end_time": 1658953439,
	"trace_id": "trace.5",
	"plugin_instance": "nest.2", 
	"records": [{
		"timestamp": 1658953439,
		"record": {
			"dummy": "dummy_0",
			"powered_by": "calyptia",
			"data": {
				"key_name": "foo", 
				"key_cnt": "1"
			}
		}
	}]
}
```

### type

The type defines at what stage the event is generated:

- type=1: input record
  - this is the unadulterated input record
- type=2: filtered record
  - this is a record once it has been filtered. One record is generated per filter.
- type=3: pre-output record
  - this is the record right before it is sent for output.

Since this is a record generated by the manipulation of a record by a filter is has the type `2`.

### start_time and end_time

This records the start and end of an event, it is a bit different for each event type:

- type 1: when the input is received, both the start and end time.
- type 2: the time when filtering is matched until it has finished processing.
- type 3: the time when the input is received and when it is finally slated for output.

### trace_id

This is a string composed of a prefix and a number which is incremented with each record received by the input during the trace session.

### plugin_instance

This is the plugin instance name as it is generated by fluent-bit at runtime.

### plugin_alias

If an alias is set this field will contain the alias set for a plugin.

# records

This is an array of all the records being sent. Since fluent-bit handles records in chunks of multiple records and chunks are indivisible the same is done in the traces. Each record consists of its timestamp followed by the actual data which is a composite type of keys and values.

[README.md](https://github.com/calyptia/core-images/files/9203490/README.md)
